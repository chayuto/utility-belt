# Ruby Hash Parser - Implementation Plan

**Document ID:** RHP-2024-12-13  
**Version:** 1.0.0  
**Status:** Planning  
**Author:** Engineering Team  
**Last Updated:** December 13, 2024

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Problem Statement](#problem-statement)
3. [Architecture Overview](#architecture-overview)
4. [Implementation Stages](#implementation-stages)
5. [Related Documents](#related-documents)

---

## Executive Summary

This document serves as the master plan for implementing `@utility-belt/ruby-hash-parser`, an industrial-grade TypeScript library for parsing Ruby Hash `inspect` output into valid JSON.

### Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Parser Technology | PEG via Peggy | Context-free grammar support, unambiguous parsing |
| Output Format | Configurable | Support strict JSON, JSON5, and preserving modes |
| Architecture | AST-based | Clean separation of parsing and transformation |
| Security Model | Sandbox | No eval(), bounded recursion, input validation |

### Scope

**In Scope:**
- Ruby Hash `inspect` output parsing (Ruby 1.8 - 3.x)
- Symbol, String, Numeric type handling
- Complex objects: Set, Range, Time, Struct, BigDecimal
- Configurable transformation strategies
- Web UI integration

**Out of Scope:**
- Full Ruby language parsing
- Ruby code execution/interpretation
- Real-time streaming of massive files (>100MB)

---

## Problem Statement

### Current State

The existing `RubyToJSON` tool uses naive regex replacement:

```typescript
// Current implementation - INADEQUATE
const processed = rubyInput
  .replace(/:(\w+)\s*=>/g, '"$1":')
  .replace(/=>/g, ':')
  .replace(/\bnil\b/g, 'null');
```

### Limitations

1. **Cannot handle nesting** - Regex is Type 3 (Chomsky), hashes are Type 2
2. **Escape sequences ignored** - `\a`, `\e`, `\xFF` cause failures
3. **No symbol variations** - `:'complex key'` not supported
4. **No Ruby types** - Infinity, NaN, BigDecimal, Range all fail
5. **No error recovery** - Cryptic JSON.parse errors

### Target State

A formal PEG parser that:
- Handles all Ruby Hash syntax variations
- Provides configurable type coercion
- Reports errors with line/column information
- Maintains production-grade performance

---

## Architecture Overview

### System Context

```
┌─────────────────────────────────────────────────────────────┐
│                      Web Application                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              RubyToJSON Tool (UI)                    │    │
│  └─────────────────────┬───────────────────────────────┘    │
│                        │                                     │
│  ┌─────────────────────▼───────────────────────────────┐    │
│  │           @utility-belt/ruby-hash-parser            │    │
│  │  ┌─────────┐  ┌─────────────┐  ┌───────────────┐   │    │
│  │  │ Grammar │→ │   Parser    │→ │  Transformer  │   │    │
│  │  │ (Peggy) │  │ (Generated) │  │  (Coercions)  │   │    │
│  │  └─────────┘  └─────────────┘  └───────────────┘   │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### Package Structure

```
packages/ruby-hash-parser/
├── package.json
├── tsconfig.json
├── tsup.config.ts
├── src/
│   ├── index.ts                 # Public API exports
│   ├── grammar/
│   │   └── ruby-hash.peggy      # PEG grammar definition
│   ├── parser/
│   │   ├── index.ts             # Parser wrapper & depth tracking
│   │   └── generated.ts         # Peggy output (gitignored)
│   ├── transformer/
│   │   ├── index.ts             # AST → JS object transformer
│   │   ├── coercions.ts         # Type coercion strategies
│   │   └── escape-handler.ts    # Ruby escape sequence processor
│   ├── types/
│   │   ├── ast.ts               # AST node type definitions
│   │   └── options.ts           # ParserOptions interface
│   └── errors/
│       └── index.ts             # Custom error classes
└── tests/
    ├── unit/                    # Per-module tests
    ├── integration/             # End-to-end tests
    └── fixtures/                # Golden master data
```

### Data Flow

```
Input String → Lexer → Parser → AST → Transformer → JS Object → JSON String
     │           │        │       │         │            │
     │           │        │       │         │            └─ JSON.stringify()
     │           │        │       │         └─ Apply coercion strategies
     │           │        │       └─ Typed syntax tree
     │           │        └─ PEG grammar rules
     │           └─ Tokenization
     └─ Ruby Hash inspect output
```

---

## Implementation Stages

| Stage | Document | Duration | Dependencies |
|-------|----------|----------|--------------|
| 1 | [Foundation & Core Grammar](./stage-1-foundation.md) | 3-4 days | None |
| 2 | [Symbol & String Handling](./stage-2-strings.md) | 3-4 days | Stage 1 |
| 3 | [Numeric Types](./stage-3-numerics.md) | 2-3 days | Stage 1 |
| 4 | [Complex Objects](./stage-4-objects.md) | 4-5 days | Stages 2, 3 |
| 5 | [Robustness & Security](./stage-5-robustness.md) | 3-4 days | Stage 4 |
| 6 | [Public API & Documentation](./stage-6-api.md) | 2-3 days | Stage 5 |
| 7 | [Web UI Integration](./stage-7-integration.md) | 2 days | Stage 6 |

### Timeline

```
Week 1: ████████████████████████████████ Stages 1-2
Week 2: ████████████████████████████████ Stages 3-4
Week 3: ████████████████████████████████ Stages 5-6
Week 4: ████████████████                 Stage 7 + Buffer
```

**Total Duration:** 3-4 weeks

---

## Related Documents

### Stage Documents
- [Stage 1: Foundation & Core Grammar](./stage-1-foundation.md)
- [Stage 2: Symbol & String Handling](./stage-2-strings.md)
- [Stage 3: Numeric Types](./stage-3-numerics.md)
- [Stage 4: Complex Objects](./stage-4-objects.md)
- [Stage 5: Robustness & Security](./stage-5-robustness.md)
- [Stage 6: Public API & Documentation](./stage-6-api.md)
- [Stage 7: Web UI Integration](./stage-7-integration.md)

### Reference
- [Research Document](../../research/Ruby%20Hash%20to%20JSON%20Conversion%20Research.md)
- [Peggy Documentation](https://peggyjs.org/)

---

## Success Criteria

| Metric | Target | Measurement |
|--------|--------|-------------|
| Correctness | 100% golden master tests pass | Automated CI |
| Performance | Parse 1MB in < 1 second | Benchmark suite |
| Coverage | > 90% code coverage | Vitest coverage |
| Security | No code execution vulnerabilities | Security review |
| Usability | Clear errors with location info | Manual QA |

---

## Approval

| Role | Name | Date | Status |
|------|------|------|--------|
| Tech Lead | | | Pending |
| Product Owner | | | Pending |

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2024-12-13 | Initial plan creation |
